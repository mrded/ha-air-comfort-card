name: Screenshot Preview

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  screenshot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Install Playwright
        run: bun add -d playwright && bunx playwright install chromium

      - name: Build
        run: bun run build

      - name: Take screenshot
        run: |
          cat > screenshot.ts << 'EOF'
          import { chromium } from 'playwright';

          async function takeScreenshot() {
            // Start a local HTTP server (ES modules don't work with file:// protocol)
            const server = Bun.serve({
              port: 3000,
              async fetch(req) {
                const url = new URL(req.url);
                let path = url.pathname === '/' ? '/test.html' : url.pathname;
                const file = Bun.file(`.${path}`);
                if (await file.exists()) {
                  return new Response(file);
                }
                return new Response('Not found', { status: 404 });
              },
            });

            const browser = await chromium.launch();
            const page = await browser.newPage();

            await page.setViewportSize({ width: 500, height: 600 });
            await page.goto('http://localhost:3000/test.html');

            // Wait for the component's internal content to render (>> pierces shadow DOM)
            await page.locator('air-comfort-card >> .card-content').waitFor();
            await page.waitForTimeout(500);

            await page.screenshot({
              path: 'screenshot-preview.png',
              clip: { x: 0, y: 0, width: 500, height: 600 }
            });

            await browser.close();
            server.stop();
            console.log('Screenshot saved to screenshot-preview.png');
          }

          takeScreenshot();
          EOF
          bun run screenshot.ts

      - name: Upload screenshot artifact
        uses: actions/upload-artifact@v4
        with:
          name: screenshot-preview
          path: screenshot-preview.png

      - name: Upload to PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;

            // Upload image as artifact and create comment with link
            const artifactUrl = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`;

            const body = `## Screenshot Preview

            ðŸ“¸ A screenshot of the component has been generated.

            **[Download screenshot from Artifacts](${artifactUrl})**

            <details>
            <summary>How to view</summary>

            1. Click the link above
            2. Scroll to "Artifacts" section
            3. Download "screenshot-preview"
            </details>`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Screenshot Preview')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: botComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }
